#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")
#@overlay/match by=overlay.all,expects="0+"
#@overlay/match-child-defaults missing_ok=True
---
users:
- name: step
  system: true
  home: /etc/step-ca
  shell: /bin/false
  sudo: False
write_files:
- path: /etc/step-ca/config/ca.json
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    {
            "root": "/etc/step-ca/certs/root_ca.crt",
            "federatedRoots": null,
            "crt": "/etc/step-ca/certs/intermediate_ca.crt",
            "key": "/etc/step-ca/secrets/intermediate_ca_key",
            "address": "(@= data.values.ip @):443",
            "insecureAddress": "",
            "dnsNames": [
                    "(@= data.values.hostname @).(@= data.values.zone @)"
            ],
            "logger": {
                    "format": "text"
            },
            "db": {
                    "type": "badgerv2",
                    "dataSource": "/etc/step-ca/db",
                    "badgerFileLoadingMode": ""
            },
            "authority": {
                    "enableAdmin": true,
                    "claims": {
                            "maxTLSCertDuration": "88660h",
                            "defaultTLSCertDuration": "8866h"
                    },
                    "policy": {
                          "x509": {
                            "allow": {
                              "dns": ["*.(@= data.values.zone @)"],
                              "ip": ["(@= data.values.subnet @)/(@= data.values.cidr_prefix @)"]
                            }
                          }
                    }
            },
            "tls": {
                    "cipherSuites": [
                            "TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256",
                            "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256"
                    ],
                    "minVersion": 1.2,
                    "maxVersion": 1.3,
                    "renegotiation": false
            }
    }
- path: /etc/caddy/Caddyfile
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    {
            skip_install_trust
            ocsp_stapling off
            https_port 8443
    }

    step.home.arpa {
            tls {
                    # must be on port 443, which is taken by step online CA
                    # http challenge must be on port 80, which is free
                    issuer acme https://step.home.arpa/acme/acme/directory {
                            email caddy@step.home.arpa
                            disable_tlsalpn_challenge
                            trusted_roots /etc/step-ca/certs/root_ca.crt
                    }
            }
            root * /usr/share/caddy
            file_server
    }
packages:
- debian-keyring
- debian-archive-keyring
- apt-transport-https
- curl
runcmd:
  - wget --progress=dot:giga https://dl.smallstep.com/gh-release/cli/docs-cli-install/v0.25.1/step-cli_0.25.1_amd64.deb
  - wget --progress=dot:giga https://dl.smallstep.com/gh-release/certificates/gh-release-header/v0.25.2/step-ca_0.25.2_amd64.deb
  - dpkg -i step-cli_0.25.1_amd64.deb
  - dpkg -i step-ca_0.25.2_amd64.deb
  - setcap CAP_NET_BIND_SERVICE=+eip $(which step-ca)
  - tr -dc A-Za-z0-9 </dev/urandom | head -c 16 > /etc/step-ca/password.txt
  - chmod 400 /etc/step-ca/password.txt
  - export STEPPATH=/etc/step-ca
  #@yaml/text-templated-strings
  - |
      step ca init --remote-management --acme \
        --name homelab-pki \
        --dns (@= data.values.hostname @).(@= data.values.zone @) \
        --address (@= data.values.ip @):443 \
        --with-ca-url https://(@= data.values.hostname @).(@= data.values.zone @) \
        --provisioner cert-provisioner \
        --password-file /etc/step-ca/password.txt
  - chown -R step:step /etc/step-ca
  - wget --progress=dot:giga https://raw.githubusercontent.com/smallstep/certificates/v0.25.2/systemd/step-ca.service -O /etc/systemd/system/step-ca.service
  - cp -r /etc/step-ca/certs/* /usr/local/share/ca-certificates/
  - chmod -R a+r /usr/local/share/ca-certificates/*.crt
  - update-ca-certificates
  - systemctl daemon-reload
  - systemctl enable --now step-ca
  #@yaml/text-templated-strings
  - while ! curl -fSsL https://(@= data.values.hostname @).(@= data.values.zone @):443/health; do echo waiting for step ca; sleep 2; done
  #@yaml/text-templated-strings
  - sudo -u ubuntu -- bash -c "export STEPPATH=/home/ubuntu/.step; step ca bootstrap --ca-url https://(@= data.values.hostname @).(@= data.values.zone @):443 --install --fingerprint $(step certificate fingerprint  /usr/local/share/ca-certificates/root_ca.crt)"
  - curl -fSsL 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
  - curl -fSsL 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
  - apt-get update
  - apt-get install -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" --force-yes caddy
  - step certificate fingerprint /etc/step-ca/certs/root_ca.crt > /usr/share/caddy/fingerprint
  - cp /etc/step-ca/certs/root_ca.crt /usr/share/caddy/step_root_ca.crt
  - cp /etc/step-ca/certs/intermediate_ca.crt /usr/share/caddy/step_intermediate_ca.crt
  - rm /usr/share/caddy/index.html
  - usermod -aG step caddy
  - chmod g+rx /etc/step-ca/certs
  - chmod g+r /etc/step-ca/certs/root_ca.crt
  - chmod a+r /usr/share/caddy/*
  - systemctl restart caddy