#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")
#@overlay/match by=overlay.all,expects="0+"
#@overlay/match-child-defaults missing_ok=True
---
users:
- name: step
  system: true
  homedir: /etc/step-ca
  shell: /bin/false
  sudo: null
write_files:
- path: /run/ca.json
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    {
            "root": "/etc/step-ca/certs/root_ca.crt",
            "federatedRoots": null,
            "crt": "/etc/step-ca/certs/intermediate_ca.crt",
            "key": "/etc/step-ca/secrets/intermediate_ca_key",
            "address": "(@= data.values.ip @):443",
            "insecureAddress": "",
            "dnsNames": [
                    "(@= data.values.hostname @).(@= data.values.zone @)"
            ],
            "logger": {
                    "format": "text"
            },
            "db": {
                    "type": "badgerv2",
                    "dataSource": "/etc/step-ca/db",
                    "badgerFileLoadingMode": ""
            },
            "authority": {
                    "enableAdmin": true,
                    "claims": {
                            "maxTLSCertDuration": "88660h",
                            "defaultTLSCertDuration": "8866h"
                    },
                    "policy": {
                          "x509": {
                            "allow": {
                              "dns": ["*.(@= data.values.zone @)"],
                              "ip": ["(@= data.values.subnet @)/(@= data.values.cidr_prefix @)"]
                            }
                          }
                    }
            },
            "tls": {
                    "cipherSuites": [
                            "TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256",
                            "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256"
                    ],
                    "minVersion": 1.2,
                    "maxVersion": 1.3,
                    "renegotiation": false
            }
    }
- path: /etc/caddy/Caddyfile
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    {
            skip_install_trust
            ocsp_stapling off
            https_port 8443
    }

    step.home.arpa {
            tls {
                    # must be on port 443, which is taken by step online CA
                    # http challenge must be on port 80, which is free
                    issuer acme https://step.home.arpa/acme/acme/directory {
                            email caddy@step.home.arpa
                            disable_tlsalpn_challenge
                            trusted_roots /etc/step-ca/certs/root_ca.crt
                    }
            }
            root * /usr/share/caddy
            file_server
    }
- path: /root/runcmd
  owner: root:root
  permissions: '0750'
  content: #@ data.values.runcmd
packages:
- debian-keyring
- debian-archive-keyring
- apt-transport-https
- curl
runcmd:
- /root/runcmd