#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")
#@overlay/match by=overlay.all,expects="0+"
#@overlay/match-child-defaults missing_ok=True
---
users:
- name: #@ data.values.username
  gecos: #@ "{} {}".format(data.values.givenname, data.values.surname)
  groups: sudo
  shell: /bin/bash
  sudo: ['ALL=(ALL) NOPASSWD:ALL']
write_files:
- path: /etc/ldap/ldap.conf
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    BASE (@= data.values.suffix @)
    URI ldap://ldap.(@= data.values.zone @)
    TLS_CACERT      /etc/ssl/certs/ca-certificates.crt
- path: /usr/local/bin/changeldappassword
  owner: root:root
  permissions: '0755'
  #@yaml/text-templated-strings
  content: |
    #!/usr/bin/env bash
    set -euo pipefail
    ldappasswd -x -D uid=$(whoami),ou=people,(@= data.values.suffix @) -W -S uid=$(whoami),ou=people,(@= data.values.suffix @) -H ldaps://ldap.home.arpa
- path: /etc/nsswitch.conf
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    passwd:         files systemd ldap
    group:          files systemd ldap
    shadow:         files ldap
    gshadow:        files

    hosts:          files mdns4_minimal [NOTFOUND=return] dns
    networks:       files

    protocols:      db files
    services:       db files
    ethers:         db files
    rpc:            db files

    netgroup:       nis
- path: /usr/local/include/ldapauthhelper
  owner: root:root
  permissions: '0644'
  content: #@ data.values.ldapauthhelper
- path: /usr/local/bin/addldapgroup
  owner: root:root
  permissions: '0755'
  content: #@ data.values.addldapgroup
- path: /usr/local/bin/addldapuser
  owner: root:root
  permissions: '0755'
  content: #@ data.values.addldapuser
- path: /usr/local/bin/addldapsystem
  owner: root:root
  permissions: '0755'
  content: #@ data.values.addldapsystem
- path: /usr/local/bin/addldapusertogroup
  owner: root:root
  permissions: '0755'
  content: #@ data.values.addldapusertogroup
- path: /usr/local/bin/enable-k8s-auth.sh
  owner: root:root
  permissions: '0755'
  #@yaml/text-templated-strings
  content: #@ data.values.enable_k8s_auth_script
- path: /usr/local/bin/add-k8s-service-account.sh
  owner: root:root
  permissions: '0755'
  #@yaml/text-templated-strings
  content: #@ data.values.add_k8s_sa_script
- path: /usr/local/bin/add-app-role.sh
  owner: root:root
  permissions: '0755'
  #@yaml/text-templated-strings
  content: #@ data.values.add_app_role_script
- path: /usr/local/bin/sync-realm
  owner: root:root
  permissions: '0755'
  #@yaml/text-templated-strings
  content: #@ data.values.synccmd
- path: /etc/firefox/policies/policies.json
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    {
      "policies": {
        "Certificates": {
          "ImportEnterpriseRoots": true,
          "Install": [
            "/etc/firefox/ca-certificates/step_root_ca.crt"
          ]
        },
        "ManagedBookmarks": [
          {
            "toplevel_name": "Homelab"
          },
          {
            "name": "Proxmox",
            "url": "https://pve.home.arpa:8006"
          },
          {
            "name": "Keycloak",
            "children": [
              {
                "url": "https://keycloak.home.arpa:8443/admin/master/console",
                "name": "admin console - master realm"
              },
              {
                "url": "https://keycloak.home.arpa:8443/admin/infrastructure/console",
                "name": "admin console - infrastructure realm"
              },
              {
                "url": "https://keycloak.home.arpa:8443/realms/infrastructure/account/#/",
                "name": "account - infrastructure realm"
              }
            ]
          },
          {
            "name": "Vault",
            "url": "https://vault.home.arpa:8200/ui/vault/auth?with=oidc"
          }
        ]
      }
    }
- path: /usr/lib/thunderbird/distribution/policies.json
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    {
      "policies": {
        "Certificates": {
          "ImportEnterpriseRoots": true,
          "Install": [
            "/usr/local/share/ca-certificates/step_root_ca.crt"
          ]
        }
      }
    }
- path: /etc/skel/.xscreensaver
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    # XScreenSaver Preferences File
    # Written by xscreensaver-demo 5.45
    # https://www.jwz.org/xscreensaver/

    timeout:        0:10:00
    cycle:          0:10:00
    lock:           False
    lockTimeout:    0:00:00
    passwdTimeout:  0:00:30
    visualID:       default
    installColormap:    True
    verbose:        False
    timestamp:      True
    splash:         False
    splashDuration: 0:00:05
    demoCommand:    xscreensaver-demo
    prefsCommand:   xscreensaver-demo -prefs
    nice:           10
    memoryLimit:    0
    fade:           True
    unfade:         False
    fadeSeconds:    0:00:03
    fadeTicks:      20
    captureStderr:  True
    ignoreUninstalledPrograms:False
    font:           *-medium-r-*-140-*-m-*
    dpmsEnabled:    False
    dpmsQuickOff:   False
    dpmsStandby:    2:00:00
    dpmsSuspend:    2:00:00
    dpmsOff:        4:00:00
    grabDesktopImages:  False
    grabVideoFrames:    False
    chooseRandomImages: False
    imageDirectory:

    mode:           blank
    selected:       118

    textMode:       url
    textLiteral:    XScreenSaver
    textFile:
    textProgram:    fortune
    textURL:        https://feeds.feedburner.com/ubuntu-news

    pointerPollTime:    0:00:05
    pointerHysteresis:  10
    windowCreationTimeout:0:00:30
    initialDelay:   0:00:00
    GetViewPortIsFullOfLies:False
    procInterrupts: True
    xinputExtensionDev: False
    overlayStderr:  True
    authWarningSlack:   20
- path: /etc/skel/.homelab
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    export VAULT_ADDR=https://vault.home.arpa:8200
    if [[ ! -d ~/.step ]]
    then
      step ca bootstrap --ca-url https://step.home.arpa --install --fingerprint $(curl -fSsL https://step.home.arpa:8443/fingerprint)
    fi
- path: /root/runcmd
  owner: root:root
  permissions: '0750'
  #@yaml/text-templated-strings
  content: #@ data.values.runcmd
packages:
 - bind9utils
 - dnsutils
 - jq
 - openjdk-19-jre-headless
 - thunderbird
runcmd:
- /root/runcmd