#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")
#@overlay/match by=overlay.all,expects="0+"
#@overlay/match-child-defaults missing_ok=True
---
groups:
- bind
users:
- name: dns-ops
  homedir: /home/dns-ops
  shell: /bin/bash
  lock_passwd: True
  gecos: DNS Ops Team
  groups: [bind]
  sudo: |
    ALL=(root) NOPASSWD: /usr/local/bin/addhost.sh, /usr/local/bin/removehost.sh, /usr/local/bin/aliashost.sh, /usr/local/bin/add-update-policy.sh, /usr/local/bin/add-allow-transfer.sh, /usr/sbin/rndc
write_files:
- path: /etc/bind/named.conf
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    include "/etc/bind/named.conf.options";
    include "/etc/bind/named.conf.local";
    include "/etc/bind/named.conf.default-zones";
    include "/etc/bind/named.conf.tsigkeys";
- path: /etc/bind/named.conf.options
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    acl internal-network {
      (@= "{}.0/{};".format(data.values.subnet, data.values.cidr_prefix) @)
    };
    options {
            directory "/var/cache/bind";
            allow-query { localhost; internal-network; };
            allow-transfer { localhost; };
            forwarders { (@= data.values.forwarders @) };
            recursion yes;
            dnssec-validation auto;
            listen-on-v6 { any; };
    };
- path: /etc/bind/named.conf.local
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    zone "(@= data.values.zone @)" IN {
            type master;
            file "/var/lib/bind/forward.(@= data.values.zone @)";
            include "/etc/bind/named.conf.update-policy";
            include "/etc/bind/named.conf.allow-transfer";
    };
    zone "(@= data.values.reverse_zone @)" IN {
            type master;
            file "/var/lib/bind/reverse.(@= data.values.zone @)";
            update-policy {
              grant local-ddns zonesub any;
            };
    };
- path: /etc/bind/named.conf.update-policy
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    update-policy {
      grant local-ddns zonesub any;
    };
- path: /etc/bind/named.conf.allow-transfer
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    allow-transfer {
      key local-ddns;
    };
- path: #@ "/var/lib/bind/forward.{}".format(data.values.zone)
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    $TTL 604800
    @ IN SOA (@= data.values.hostname @).(@= data.values.zone @). root.(@= data.values.hostname @).(@= data.values.zone @). (
             2022072651 ; Serial
             3600 ; Refresh
             180 ; Retry
             604800 ; Expire
             180 ; Negative Cache TTL
    )
    ;Name Server Information
    @ IN NS (@= data.values.hostname @).(@= data.values.zone @).

    ;IP address of Your Domain Name Server(DNS)
    (@= data.values.hostname @) IN A (@= data.values.ip @)

    ;Mail Server MX (Mail exchanger) Record
    ;(@= data.values.zone @). IN MX 10 mail.(@= data.values.zone @).

    ;A Record for Host names
    ;www IN A 192.168.0.50
    ;mail IN A 192.168.0.60

    ;CNAME Record
    ;ftp IN CNAME www.(@= data.values.zone @).
- path: #@ "/var/lib/bind/reverse.{}".format(data.values.zone)
  owner: root:root
  permissions: '0644'
  #@yaml/text-templated-strings
  content: |
    $TTL 86400
    @ IN SOA (@= data.values.zone @). root.(@= data.values.zone @). (
             2022072752 ;Serial
             3600 ;Refresh
             180 ;Retry
             604800 ;Expire
             86400 ;Minimum TTL
    )
    ;Your Name Server Info
    @ IN NS (@= data.values.hostname @).(@= data.values.zone @).
    (@= data.values.hostname @) IN A (@= data.values.ip @)
    ;Reverse Lookup for Your DNS Server
    (@= data.values.last @) IN PTR (@= data.values.hostname @).(@= data.values.zone @).
    ;PTR Record IP address to HostName
    ;200 IN PTR pve.(@= data.values.zone @).
- path: /etc/default/named
  owner: root:root
  permissions: '0644'
  content: |
    # run resolvconf?
    RESOLVCONF=no
    # startup options for the server
    OPTIONS="-u bind -4"
- path: /usr/local/bin/addhost.sh
  owner: root:root
  permissions: '0755'
  #@yaml/text-templated-strings
  content: |
    #!/usr/bin/env bash
    set -euo pipefail

    HOST=$1
    IP=$2

    ZONE=(@= data.values.zone @)

    sudo nsupdate -l -4 <<EOF
    zone $ZONE
    update add ${HOST}.${ZONE} 60 A $IP
    send
    EOF

    named-checkzone ${ZONE} /var/lib/bind/forward.${ZONE}

    if ! grep -q '*' <<< $HOST
    then
      REV_ZONE=(@= data.values.reverse_zone @)
      segment=$(cut -d'.' -f4 <<< "$IP")

      sudo nsupdate -l -4 <<EOF
      zone $REV_ZONE
    update add ${segment}.${REV_ZONE} 60 PTR ${HOST}.${ZONE}
    send
    EOF

      named-checkzone ${REV_ZONE} /var/lib/bind/reverse.${ZONE}
    fi

    while [[ -z "$(dig -4 ${HOST}.${ZONE} @localhost +noall +answer)" ]]
    do
      sleep 2
      echo retry
    done
    echo resolving ${HOST}.${ZONE} to $(dig -4 ${HOST}.${ZONE} @localhost +noall +answer)
- path: /usr/local/bin/removehost.sh
  owner: root:root
  permissions: '0755'
  #@yaml/text-templated-strings
  content: |
    #!/usr/bin/env bash
    set -euo pipefail

    HOST=$1
    IP=$2

    ZONE=(@= data.values.zone @)
    REV_ZONE=(@= data.values.reverse_zone @)

    sudo nsupdate -l -4 <<EOF
    zone $ZONE
    update delete ${HOST}.${ZONE}
    send
    EOF

    named-checkzone ${ZONE} /var/lib/bind/forward.${ZONE}

    if ! grep -q '*' <<< $HOST
    then
      REV_ZONE=(@= data.values.reverse_zone @)
      segment=$(cut -d'.' -f4 <<< "$IP")

      sudo nsupdate -l -4 <<EOF
      zone $REV_ZONE
    update delete ${segment}.${REV_ZONE}
    send
    EOF
      named-checkzone ${REV_ZONE} /var/lib/bind/reverse.${ZONE}
    fi
- path: /usr/local/bin/aliashost.sh
  owner: root:root
  permissions: '0755'
  #@yaml/text-templated-strings
  content: |
    #!/usr/bin/env bash
    set -euo pipefail

    HOST_ALIAS=$1
    CANONICAL_FQDN=$2

    ZONE=(@= data.values.zone @)

    if ! grep -q '\.$' <<< "$CANONICAL_FQDN"
    then
      CANONICAL_FQDN="$CANONICAL_FQDN."
    fi

    sudo nsupdate -l -4 <<EOF
    zone $ZONE
    update add ${HOST_ALIAS}.${ZONE} 60 CNAME $CANONICAL_FQDN
    send
    EOF

    named-checkzone ${ZONE} /var/lib/bind/forward.${ZONE}
- path: /usr/local/bin/add-update-policy.sh
  owner: root:root
  permissions: '0755'
  #@yaml/text-templated-strings
  content: |
    #!/usr/bin/env bash
    set -euo pipefail

    sed -i.bk$(date +%s) "s/};/  $@\n};/" /etc/bind/named.conf.update-policy
    sudo rndc reload
- path: /usr/local/bin/add-allow-transfer.sh
  owner: root:root
  permissions: '0755'
  #@yaml/text-templated-strings
  content: |
    #!/usr/bin/env bash
    set -euo pipefail

    sed -i.bk$(date +%s) "s/};/  $@\n};/" /etc/bind/named.conf.allow-transfer
    sudo rndc reload
- path: /root/runcmd
  owner: root:root
  permissions: '0755'
  content: #@ data.values.runcmd
packages:
 - bind9
 - bind9utils
 - bind9-doc
 - dnsutils
runcmd: 
- /root/runcmd